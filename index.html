<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>精拓生技 電子書閱讀器</title>
    <style>
        :root {
            --bg-color: #333;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            height: 100dvh; /* 使用 dvh 避免手機網址列遮擋 */
            width: 100vw;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            /* 關鍵：完全禁止瀏覽器的預設手勢，交給 JS 處理 */
            touch-action: none; 
        }

        .viewport-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }

        /* --- 書本舞台區 --- */
        .stage-area {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden; /* 確保放大的圖片不會超出舞台 */
            perspective: 1500px;
            padding: 10px;
            position: relative;
        }

        .book {
            position: relative;
            transform-style: preserve-3d;
            /* 鎖定 9:16 比例 */
            aspect-ratio: 9 / 16;
            height: 100%;
            max-height: 100%;
            width: auto;
            max-width: 100%;
            transition: transform 0.4s ease;
        }

        .page {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: transparent;
            border: none;
            
            transform-origin: left center;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.645, 0.045, 0.355, 1);
            
            border-radius: 4px;
            display: flex;
            justify-content: center;
            align-items: center;
            backface-visibility: hidden;
            overflow: hidden;
        }

        /* 圖片容器：用於處理縮放動畫 */
        .img-wrapper {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .page img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* 保持比例 */
            /* 縮放動畫 */
            transition: transform 0.2s ease-out; 
            transform-origin: center center;
            will-change: transform; /* 效能優化 */
        }

        .page.flipped {
            transform: rotateY(-180deg);
        }

        /* --- 控制區 --- */
        .controls {
            flex-shrink: 0;
            height: 80px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.3);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 100;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 20px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        button {
            border: none;
            background: #333;
            color: #fff;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        button:active { background: #555; }
        button:disabled { background: #ccc; opacity: 0.5; cursor: not-allowed; }

        .page-info {
            font-size: 14px;
            color: #333;
            min-width: 45px;
            text-align: center;
            font-weight: bold;
        }

        .jump-box {
            display: flex;
            align-items: center;
            gap: 5px;
            border-left: 1px solid #ccc;
            padding-left: 10px;
        }

        input[type="number"] {
            width: 45px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
        }
        
        /* 縮放提示按鈕 (選用) */
        .zoom-hint {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0.7;
            z-index: 50;
        }

        @media (max-width: 400px) {
            .control-panel { padding: 8px 10px; gap: 5px; width: 95%; justify-content: space-between; }
            button { padding: 8px 10px; font-size: 13px; }
        }
    </style>
</head>
<body>

    <div class="viewport-container" id="touch-zone">
        <div class="stage-area">
            <div class="zoom-hint">雙擊圖片縮放</div>
            <div class="book" id="book">
                <div class="page" style="z-index: 2;" id="page-0">
                    <div class="img-wrapper">
                        <img src="0.JPG" alt="Page 0" id="img-0">
                    </div>
                </div>
                <div class="page" style="z-index: 1;" id="page-1">
                    <div class="img-wrapper">
                        <img src="1.JPG" alt="Page 1" id="img-1">
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="control-panel">
                <button id="btn-prev" onclick="handleBtnPrev()">上一頁</button>
                <span class="page-info">
                    <span id="current-page">1</span> / <span id="total-pages">2</span>
                </span>
                <button id="btn-next" onclick="handleBtnNext()">下一頁</button>
                
                <div class="jump-box">
                    <input type="number" id="jump-input" min="1" placeholder="頁">
                    <button onclick="jumpToPage()">GO</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 設定
        const totalImages = 2; 
        let currentPageIndex = 0; 

        // 縮放相關變數
        let isZoomed = false;
        let scale = 1;
        let translateX = 0;
        let translateY = 0;
        
        // 觸控變數
        let lastTapTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        let lastTouchX = 0;
        let lastTouchY = 0;

        // DOM
        const pageCountSpan = document.getElementById('total-pages');
        const currentSpan = document.getElementById('current-page');
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        const pages = document.querySelectorAll('.page');
        const touchZone = document.getElementById('touch-zone');

        function init() {
            pageCountSpan.innerText = totalImages;
            updateZIndexes();
            updateControls();
            setupTouchEvents();
        }

        // --- 核心：觸控事件處理 ---
        function setupTouchEvents() {
            touchZone.addEventListener('touchstart', e => {
                const touch = e.touches[0];
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTapTime;

                // 紀錄初始位置
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;

                // 偵測雙擊 (Double Tap)
                if (tapLength < 300 && tapLength > 0) {
                    toggleZoom();
                    e.preventDefault(); // 防止瀏覽器預設縮放
                }
                lastTapTime = currentTime;

            }, { passive: false });

            touchZone.addEventListener('touchmove', e => {
                e.preventDefault(); // 阻止瀏覽器滾動
                
                if (e.touches.length > 1) return; // 暫不處理多指縮放，避免複雜

                const touch = e.touches[0];
                const deltaX = touch.clientX - lastTouchX;
                const deltaY = touch.clientY - lastTouchY;

                if (isZoomed) {
                    // 1. 如果已放大 -> 執行拖曳 (Pan)
                    translateX += deltaX;
                    translateY += deltaY;
                    applyTransform();
                } else {
                    // 2. 如果未放大 -> 等待手指放開後判斷翻頁，這裡不做事
                }

                lastTouchX = touch.clientX;
                lastTouchY = touch.clientY;
            }, { passive: false });

            touchZone.addEventListener('touchend', e => {
                if (isZoomed) return; // 放大狀態下，放開手指不翻頁

                const touchEndX = e.changedTouches[0].clientX;
                const totalDeltaX = touchEndX - touchStartX;
                const threshold = 50; // 翻頁靈敏度

                // 判斷滑動翻頁
                if (Math.abs(totalDeltaX) > threshold) {
                    if (totalDeltaX < 0) {
                        nextPage(); // 向左滑
                    } else {
                        prevPage(); // 向右滑
                    }
                }
            }, { passive: false });
        }

        // --- 縮放功能 ---
        function toggleZoom() {
            const currentImg = document.getElementById(`img-${currentPageIndex}`);
            
            if (isZoomed) {
                // 還原
                scale = 1;
                translateX = 0;
                translateY = 0;
                isZoomed = false;
                // 恢復翻頁按鈕
                btnPrev.disabled = currentPageIndex === 0;
                btnNext.disabled = currentPageIndex === totalImages - 1;
            } else {
                // 放大
                scale = 2.5; // 放大 2.5 倍
                isZoomed = true;
                // 放大時禁用翻頁按鈕，避免誤觸
                btnPrev.disabled = true;
                btnNext.disabled = true;
            }
            applyTransform();
        }

        function applyTransform() {
            const currentImg = document.getElementById(`img-${currentPageIndex}`);
            if (currentImg) {
                // 使用 CSS transform 移動與縮放
                currentImg.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            }
        }

        function resetZoomState() {
            // 換頁時，強制重置縮放狀態
            if (isZoomed) {
                const prevImg = document.getElementById(`img-${currentPageIndex}`); // 舊頁面
                if(prevImg) prevImg.style.transform = 'translate(0,0) scale(1)';
                
                scale = 1;
                translateX = 0;
                translateY = 0;
                isZoomed = false;
            }
        }

        // --- 翻頁邏輯 ---
        function nextPage() {
            if (isZoomed) return; // 放大時禁止翻頁
            if (currentPageIndex >= totalImages - 1) return;

            resetZoomState(); // 確保下一頁是從原始大小開始
            
            const currentEl = document.getElementById(`page-${currentPageIndex}`);
            currentEl.classList.add('flipped');
            currentPageIndex++;
            updateUI();
        }

        function prevPage() {
            if (isZoomed) return;
            if (currentPageIndex <= 0) return;

            resetZoomState();

            currentPageIndex--;
            const prevEl = document.getElementById(`page-${currentPageIndex}`);
            prevEl.classList.remove('flipped');
            updateUI();
        }

        // 按鈕觸發的翻頁（需判斷是否在放大模式）
        function handleBtnNext() {
            if (isZoomed) toggleZoom(); // 如果在放大模式點下一頁，先縮小
            else nextPage();
        }

        function handleBtnPrev() {
            if (isZoomed) toggleZoom();
            else prevPage();
        }

        function jumpToPage() {
            const input = document.getElementById('jump-input');
            let targetPage = parseInt(input.value);

            if (isNaN(targetPage) || targetPage < 1 || targetPage > totalImages) {
                alert('請輸入有效的頁碼');
                return;
            }

            resetZoomState(); // 跳轉前重置

            let targetIndex = targetPage - 1;

            if (targetIndex > currentPageIndex) {
                for (let i = currentPageIndex; i < targetIndex; i++) {
                    document.getElementById(`page-${i}`).classList.add('flipped');
                }
            } 
            else if (targetIndex < currentPageIndex) {
                for (let i = currentPageIndex - 1; i >= targetIndex; i--) {
                    document.getElementById(`page-${i}`).classList.remove('flipped');
                }
            }

            currentPageIndex = targetIndex;
            updateUI();
            input.value = '';
        }

        function updateZIndexes() {
            pages.forEach((page, index) => {
                if (index > currentPageIndex) {
                    page.style.zIndex = totalImages - index;
                    page.style.display = 'flex';
                } else if (index === currentPageIndex) {
                      page.style.zIndex = totalImages + 1;
                      page.style.display = 'flex';
                } else {
                    page.style.zIndex = index;
                }
            });
        }

        function updateUI() {
            currentSpan.innerText = currentPageIndex + 1;
            btnPrev.disabled = currentPageIndex === 0;
            btnNext.disabled = currentPageIndex === totalImages - 1;
            updateZIndexes();
        }

        init();
    </script>
</body>
</html>
